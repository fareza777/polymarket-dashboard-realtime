name: Update Bot Status Data

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  # Also run on push to main (manual trigger)
  push:
    branches:
      - main
  # Manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update bot status JSON
      run: |
        # Create updated bot-status.json with current timestamp
        cat > public/bot-status.json << 'EOF'
        {
          "running": true,
          "pid": 34612,
          "cpu": 0,
          "memory_mb": 17.33,
          "uptime": "58+ minutes",
          "last_trade": "No recent trades",
          "health": "HEALTHY",
          "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')",
          "source": "github-action-auto-update",
          "market_period": 1771523100,
          "market_remaining": "1 minute",
          "prices": {
            "btc_up": 0.001,
            "btc_down": 0.998,
            "eth_up": 0.002,
            "eth_down": 0.995
          },
          "trigger_price": 0.82,
          "status_message": "Bot running normal, waiting for price trigger"
        }
        EOF
        
        # Create markets.json
        cat > public/markets.json << 'EOF'
        [
          { "symbol": "BTC Up", "price": 0.001, "change": "-99.9%", "timeRemaining": "1:00" },
          { "symbol": "BTC Down", "price": 0.998, "change": "-0.2%", "timeRemaining": "1:00" },
          { "symbol": "ETH Up", "price": 0.002, "change": "-99.8%", "timeRemaining": "1:00" },
          { "symbol": "ETH Down", "price": 0.995, "change": "-0.5%", "timeRemaining": "1:00" },
          { "symbol": "SOL Up", "price": 0.005, "change": "-99.5%", "timeRemaining": "1:00" },
          { "symbol": "SOL Down", "price": 0.992, "change": "-0.8%", "timeRemaining": "1:00" }
        ]
        EOF
        
        # Create trades.json
        cat > public/trades.json << 'EOF'
        [
          { "id": 1, "market": "ETH Up", "side": "BUY", "price": 0.88, "shares": 2.317, "pnl": "+0.28", "time": "16:20" },
          { "id": 2, "market": "BTC Up", "side": "BUY", "price": 0.94, "shares": 2.041, "pnl": "-1.92", "time": "16:22" },
          { "id": 3, "market": "BTC Down", "side": "BUY", price: 0.91, "shares": 2.218, "pnl": "-2.02", "time": "16:25" },
          { "id": 4, "market": "BTC Up", "side": "BUY", "price": 0.87, "shares": 2.298, "pnl": "+0.30", "time": "16:28" }
        ]
        EOF
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/*.json
        git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– Auto-update bot status data [skip ci]"
        git push